<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Van Comms</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <style>
        body {
            background: #020617;
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            display: flex;
        }

        /* LEFT — MONITOR */
        #camera-container {
            width: 70%;
            height: 100vh;
            background: #000;
            border-right: 2px solid #0ff;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        /* PHASMO "NO FEED" GLOW TEXT */
        .no-feed-text {
            font-size: 42px;
            letter-spacing: 4px;
            color: #0ff;
            opacity: 0.8;
            text-shadow: 0 0 20px #0ff, 0 0 40px #0ff;
            animation: flicker 2s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.4; }
        }

        /* RIGHT — CHAT */
        #chat-panel {
            width: 30%;
            height: 100vh;
            background: #05101f;
            padding: 10px;
            box-sizing: border-box;
            border-left: 2px solid #0ff;
            display: flex;
            flex-direction: column;
        }

        #chat-log {
            flex-grow: 1;
            background: #000;
            color: #0ff;
            padding: 10px;
            border: 2px solid #0ff;
            overflow-y: auto;
            font-size: 14px;
        }

        #chat-input {
            display: flex;
            margin-top: 10px;
        }

        #chat-input input {
            flex-grow: 1;
            padding: 10px;
            background: #0a1a2f;
            border: 2px solid #0ff;
            color: #0ff;
        }

        #chat-input button {
            padding: 10px 20px;
            background: #0ff;
            border: none;
            cursor: pointer;
            color: #000;
            margin-left: 5px;
            font-weight: bold;
        }

        .system {
            color: #6cf;
        }

        /* BUTTON TO OPEN JITSI */
        #open-voice {
            margin-top: 10px;
            padding: 10px;
            background: #0ff;
            border: none;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            width: 100%;
        }
    </style>
</head>

<body>

    <!-- LEFT: NO VIDEO FEED SCREEN -->
    <div id="camera-container">
        <div class="no-feed-text">NO VIDEO FEED</div>
    </div>

    <!-- RIGHT: CHAT SECTION -->
    <div id="chat-panel">
        <h3 style="color:#0ff; margin:0 0 10px 0;">VAN COMMS</h3>

        <div id="chat-log"></div>

        <div id="chat-input">
            <input id="messageBox" type="text" placeholder="Type a message..." />
            <button onclick="sendMessage()">Send</button>
        </div>

        <button id="open-voice" onclick="openJitsi()">Open Voice Room</button>
    </div>

    <!-- FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import {
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            serverTimestamp,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2WA7yotRlqNidwIgJcT19JNrK8ukMgs4",
            authDomain: "phasmophobiabroads.firebaseapp.com",
            projectId: "phasmophobiabroads",
            storageBucket: "phasmophobiabroads.firebasestorage.app",
            messagingSenderId: "503659624108",
            appId: "1:503659624108:web:6e57fbc6bf36b0d5989109"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const room = urlParams.get("room") || "default";
        const username = urlParams.get("name") || "Investigator";

        const messagesRef = collection(db, "rooms", room, "messages");

        async function sendMessage() {
            const msg = messageBox.value.trim();
            if (msg.length === 0) return;

            await addDoc(messagesRef, {
                sender: username,
                text: msg,
                timestamp: serverTimestamp()
            });

            messageBox.value = "";
        }

        const q = query(messagesRef, orderBy("timestamp"));
        onSnapshot(q, (snapshot) => {
            chatLog.innerHTML = "";
            snapshot.forEach((doc) => {
                const data = doc.data();
                const line = document.createElement("div");

                line.innerHTML = `<span class="system">[${data.sender}]</span> ${data.text}`;
                chatLog.appendChild(line);
            });

            chatLog.scrollTop = chatLog.scrollHeight;
        });

        function openJitsi() {
            window.open("https://8x8.vc/phasmobroads/" + room, "_blank");
        }
    </script>

</body>
</html>
